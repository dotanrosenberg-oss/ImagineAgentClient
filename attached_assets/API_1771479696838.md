# ImagineWA Server — API Reference

## Authentication

All authenticated endpoints require the `x-api-key` header.

| Auth Level | Header | Description |
|---|---|---|
| **API Key** | `x-api-key: <API_KEY>` | Standard client access |
| **Admin Key** | `x-api-key: <ADMIN_API_KEY>` | Admin dashboard & management |

Endpoints that require an active WhatsApp connection will return `503 SERVICE_UNAVAILABLE` with the current state if WhatsApp is not connected.

---

## 1. Health & Status

### GET /api/healthz

Health check — no authentication required.

**Response:**
```json
{ "status": "ok", "timestamp": "2026-02-19T00:00:00.000Z" }
```

### GET /api/status

Full server status. Requires **API Key**.

**Response:**
```json
{
  "status": "ok",
  "whatsapp": {
    "state": "connected",
    "reconnectAttempts": 0
  },
  "sync": {
    "status": "idle",
    "lastSyncTime": null
  },
  "websocket": {
    "activeClients": 2
  },
  "timestamp": "2026-02-19T00:00:00.000Z"
}
```

| WhatsApp States | Description |
|---|---|
| `connected` | Authenticated and ready to send/receive |
| `connecting` | Initializing or waiting for QR scan |
| `disconnected` | Not connected |

| Sync Statuses | Description |
|---|---|
| `idle` | No sync has been run |
| `syncing` | Sync in progress |
| `synced` | Last sync completed successfully |
| `error` | Last sync failed |

---

## 2. Chats

### GET /api/chats

List all stored chats. Requires **API Key**.

**Response:**
```json
{
  "chats": [
    {
      "id": "1234567890@c.us",
      "name": "John Doe",
      "isGroup": false,
      "participantCount": null,
      "isAdmin": null,
      "lastMessageAt": "2026-02-19T00:00:00.000Z",
      "metadata": null
    }
  ]
}
```

### GET /api/chats/:chatId

Get a single chat by ID. Requires **API Key**.

**Response:**
```json
{
  "chat": {
    "id": "1234567890@c.us",
    "name": "John Doe",
    "isGroup": false,
    "participantCount": null,
    "isAdmin": null,
    "lastMessageAt": null,
    "metadata": null
  }
}
```

**Errors:**
- `404` — Chat not found

### POST /api/chats/sync

Sync chats from WhatsApp into the local database. Requires **API Key** + **WhatsApp connected**.

**Response:**
```json
{ "status": "synced", "timestamp": "2026-02-19T00:00:00.000Z" }
```

**Errors:**
- `503` — WhatsApp not connected
- `500` — Sync failed

---

## 3. Messages

### GET /api/chats/:chatId/messages

Get stored messages from the database. Requires **API Key**.

**Query Parameters:**
| Param | Type | Default | Description |
|---|---|---|---|
| `limit` | integer | 50 | Max messages to return |

**Response:**
```json
{
  "messages": [
    {
      "id": "msg_abc123",
      "chatId": "1234567890@c.us",
      "sender": "1234567890@c.us",
      "body": "Hello!",
      "type": "text",
      "mediaUrl": null,
      "timestamp": "2026-02-19T00:00:00.000Z",
      "isEdited": false,
      "isDeleted": false
    }
  ]
}
```

### GET /api/whatsapp/messages/:chatId

Get messages directly from WhatsApp (live, not from DB). Requires **API Key** + **WhatsApp connected**.

**Query Parameters:**
| Param | Type | Default | Description |
|---|---|---|---|
| `limit` | integer | 50 | Max messages to return |

**Response:** Same structure as above.

### POST /api/messages/send

Send a text message. Requires **API Key** + **WhatsApp connected**.

**Request Body:**
```json
{
  "chatId": "1234567890@c.us",
  "message": "Hello!",
  "quotedMessageId": "optional_msg_id"
}
```

| Field | Type | Required | Description |
|---|---|---|---|
| `chatId` | string | Yes | Recipient chat ID |
| `message` | string | Yes | Message text |
| `quotedMessageId` | string | No | ID of message to reply to |

**Response:**
```json
{
  "success": true,
  "messageId": "msg_abc123",
  "message": { ... }
}
```

### POST /api/messages/send-media

Send a file or media. Requires **API Key** + **WhatsApp connected**.

**Content-Type:** `multipart/form-data`

| Field | Type | Required | Description |
|---|---|---|---|
| `chatId` | string | Yes | Recipient chat ID |
| `file` | file | Yes | File to send (max 16 MB) |
| `caption` | string | No | Caption for the media |

**Response:**
```json
{
  "success": true,
  "messageId": "msg_abc123",
  "message": { ... }
}
```

### PATCH /api/chats/:chatId/messages/:messageId

Edit a previously sent message. Requires **API Key** + **WhatsApp connected**.

**Request Body:**
```json
{ "body": "Updated message text" }
```

**Response:**
```json
{ "success": true, "message": { ... } }
```

**Errors:**
- `404` — Message not found

### DELETE /api/chats/:chatId/messages/:messageId

Delete a message. Requires **API Key** + **WhatsApp connected**.

**Response:**
```json
{ "success": true }
```

**Errors:**
- `404` — Message not found

---

## 4. Groups

### Complete Group Creation Workflow

The typical flow for creating a fully configured group:

1. **Create the group** — `POST /api/groups/create`
2. **Set the group image** — `POST /api/groups/set-image`
3. **Add more members** (optional) — `POST /api/groups/add-members`
4. **Generate join links** (optional) — `POST /api/groups/join-url`

#### Phone Number Formats

The API automatically sanitizes phone numbers. All of these formats work:

| Input | Resolved To |
|---|---|
| `+16467996276` | `16467996276@c.us` |
| `1-646-799-6276` | `16467996276@c.us` |
| `(646) 799-6276` | `6467996276@c.us` |
| `16467996276` | `16467996276@c.us` |
| `16467996276@c.us` | `16467996276@c.us` (kept as-is) |

Always include the country code (e.g. `1` for US, `972` for Israel) for reliable delivery.

---

### POST /api/groups/create

Create a new WhatsApp group. Requires **API Key** + **WhatsApp connected**.

**Content-Type:** `application/json`

**Request Body:**
```json
{
  "name": "My Group",
  "participants": ["+16467996276", "+972501234567"]
}
```

| Field | Type | Required | Description |
|---|---|---|---|
| `name` | string | Yes | Group name (1+ characters) |
| `participants` | string[] | Yes | At least one phone number (any format above) |

**Response:**
```json
{
  "success": true,
  "groupId": "120363012345@g.us",
  "chat": {
    "id": "120363012345@g.us",
    "name": "My Group",
    "isGroup": true,
    "participantCount": 3,
    "isAdmin": true
  }
}
```

**Errors:**
- `400 VALIDATION_ERROR` — Missing name or participants
- `500 CREATE_FAILED` — WhatsApp rejected the group (e.g. invalid phone numbers)

**curl example:**
```bash
curl -X POST http://localhost:5000/api/groups/create \
  -H "Content-Type: application/json" \
  -H "x-api-key: YOUR_API_KEY" \
  -d '{"name": "My Group", "participants": ["+16467996276"]}'
```

---

### POST /api/groups/set-image

Set or update the group's profile picture. Requires **API Key** + **WhatsApp connected**. You must be a group admin.

**Content-Type:** `multipart/form-data`

| Field | Type | Required | Description |
|---|---|---|---|
| `groupId` | string | Yes | Group ID (must end in `@g.us`) |
| `image` | file | Yes | Image file (JPEG, PNG, or WebP, max 16 MB) |

**Response:**
```json
{
  "success": true,
  "groupId": "120363012345@g.us"
}
```

**Errors:**
- `400 VALIDATION_ERROR` — Missing groupId, missing image, invalid image type, or groupId doesn't end with `@g.us`
- `500 SET_IMAGE_FAILED` — WhatsApp rejected the image (e.g. not a group admin, image too large)

**curl example:**
```bash
curl -X POST http://localhost:5000/api/groups/set-image \
  -H "x-api-key: YOUR_API_KEY" \
  -F "groupId=120363012345@g.us" \
  -F "image=@/path/to/group-photo.jpg"
```

**JavaScript (fetch) example:**
```javascript
const formData = new FormData();
formData.append("groupId", "120363012345@g.us");
formData.append("image", fileInput.files[0]);

const response = await fetch("/api/groups/set-image", {
  method: "POST",
  headers: { "x-api-key": "YOUR_API_KEY" },
  body: formData,
});
const result = await response.json();
```

**Notes:**
- WhatsApp will crop the image to a square — best to upload a square image
- Recommended image size: 500x500 to 1000x1000 pixels
- You must be an admin of the group to change its image

---

### POST /api/groups/add-members

Add members to an existing group. Requires **API Key** + **WhatsApp connected**. Group IDs only (must end in `@g.us`).

**Content-Type:** `application/json`

**Request Body:**
```json
{
  "groupId": "120363012345@g.us",
  "participants": ["+16467996276", "+972501234567"]
}
```

| Field | Type | Required | Description |
|---|---|---|---|
| `groupId` | string | Yes | Group ID (must end in `@g.us`) |
| `participants` | string[] | Yes | Phone numbers to add (any format) |

**Response:**
```json
{
  "success": true,
  "added": ["16467996276@c.us"],
  "failed": ["972501234567@c.us"]
}
```

Failed additions are logged in the database and can be queried via `/api/groups/:groupId/failed-attempts`.

**curl example:**
```bash
curl -X POST http://localhost:5000/api/groups/add-members \
  -H "Content-Type: application/json" \
  -H "x-api-key: YOUR_API_KEY" \
  -d '{"groupId": "120363012345@g.us", "participants": ["+16467996276"]}'
```

---

### Full Workflow Example

Create a group, set its image, and add members — all in sequence:

```javascript
const API_KEY = "YOUR_API_KEY";
const BASE = "http://localhost:5000";

// Step 1: Create the group
const createRes = await fetch(`${BASE}/api/groups/create`, {
  method: "POST",
  headers: { "Content-Type": "application/json", "x-api-key": API_KEY },
  body: JSON.stringify({
    name: "Project Alpha",
    participants: ["+16467996276"],
  }),
});
const { groupId } = await createRes.json();
console.log("Group created:", groupId);

// Step 2: Set group image
const imageForm = new FormData();
imageForm.append("groupId", groupId);
imageForm.append("image", imageFile); // File object or Blob
await fetch(`${BASE}/api/groups/set-image`, {
  method: "POST",
  headers: { "x-api-key": API_KEY },
  body: imageForm,
});
console.log("Group image set");

// Step 3: Add more members
await fetch(`${BASE}/api/groups/add-members`, {
  method: "POST",
  headers: { "Content-Type": "application/json", "x-api-key": API_KEY },
  body: JSON.stringify({
    groupId,
    participants: ["+972501234567", "+447911123456"],
  }),
});
console.log("Members added");
```

---

### POST /api/groups/join-url

Generate a join link for a group. Requires **API Key** + **WhatsApp connected**. Group IDs only.

**Content-Type:** `application/json`

**Request Body:**
```json
{ "groupId": "120363012345@g.us" }
```

**Response:**
```json
{
  "success": true,
  "joinUrl": "http://host/api/groups/join/abc123xyznano16",
  "token": "abc123xyznano16",
  "data": { ... }
}
```

### GET /api/groups/:groupId/join-urls

List all join links for a group. Requires **API Key**. Group IDs only.

**Response:**
```json
{
  "joinUrls": [
    {
      "id": 1,
      "groupId": "120363012345@g.us",
      "token": "abc123xyznano16",
      "isActive": true,
      "expiresAt": null,
      "createdAt": "2026-02-19T00:00:00.000Z"
    }
  ]
}
```

### GET /api/groups/:groupId/failed-attempts

List failed member-add attempts for a group. Requires **API Key**. Group IDs only.

**Response:**
```json
{
  "attempts": [
    {
      "id": 1,
      "groupId": "120363012345@g.us",
      "phoneNumber": "16467996276@c.us",
      "reason": "Failed to add",
      "attemptedAt": "2026-02-19T00:00:00.000Z"
    }
  ]
}
```

### GET /api/groups/join/:token

Validate a join link. **No authentication required** (public endpoint).

**Response (valid):**
```json
{
  "success": true,
  "groupId": "120363012345@g.us",
  "message": "Join link valid. Use WhatsApp to join this group."
}
```

**Errors:**
- `404` — Invalid or unknown token
- `410` — Link has expired

---

## 5. WhatsApp Management (Admin)

### GET /api/wa/qr

Get the current QR code for WhatsApp authentication. Requires **Admin Key**.

**Response (QR available):**
```json
{
  "state": "connecting",
  "qr": "data:image/png;base64,...",
  "qrGeneratedAt": 1771453548172
}
```

**Response (already connected):**
```json
{ "state": "connected", "qr": null, "message": "Already connected" }
```

**Response (QR not yet generated):**
```json
{ "state": "disconnected", "qr": null, "message": "QR code not yet available. Wait for WhatsApp to generate one." }
```

### POST /api/wa/restart

Restart the WhatsApp connection (disconnect then reconnect). Requires **Admin Key**.

**Response:**
```json
{ "success": true, "message": "WhatsApp restart initiated" }
```

### POST /api/wa/disconnect

Disconnect WhatsApp. Requires **Admin Key**.

**Response:**
```json
{ "success": true }
```

---

## 6. Admin Dashboard APIs

### GET /api/admin/metrics

Dashboard overview metrics. Requires **Admin Key**.

**Response:**
```json
{
  "active_ws_clients": 2,
  "chats": { "total": 10, "groups": 3, "individuals": 7 },
  "logs": { "total": 150, "errors": 2, "warnings": 5 },
  "last_sync_time": null,
  "wa_state": "connected",
  "reconnect_attempts": 0,
  "timestamp": "2026-02-19T00:00:00.000Z"
}
```

### GET /api/admin/logs

Query server logs with optional filters. Requires **Admin Key**.

**Query Parameters:**
| Param | Type | Default | Description |
|---|---|---|---|
| `level` | string | all | Filter by level: `info`, `warn`, `error`, `debug` |
| `type` | string | all | Filter by type: `system`, `message`, `group`, `sync`, `info` |
| `limit` | integer | 100 | Max log entries to return |

**Response:**
```json
{
  "logs": [
    {
      "id": 1,
      "level": "info",
      "type": "system",
      "message": "Server started",
      "createdAt": "2026-02-19T00:00:00.000Z"
    }
  ]
}
```

### GET /api/admin/recent-logs

Get recent in-memory logs (fast, no DB query). Requires **Admin Key**.

**Query Parameters:**
| Param | Type | Default | Description |
|---|---|---|---|
| `limit` | integer | 50 | Max entries to return |

**Response:** Same structure as `/api/admin/logs`.

### GET /api/admin/sync-status

WhatsApp sync status summary. Requires **Admin Key**.

**Response:**
```json
{
  "syncStatus": "idle",
  "lastSyncTime": null,
  "waState": "connected",
  "total": 10,
  "groups": 3,
  "individuals": 7
}
```

---

## 7. WebSocket (Real-Time Events)

### Connecting

```
ws://host/ws?apiKey=<API_KEY>
```

Authentication is via the `apiKey` query parameter. Invalid keys result in immediate disconnection with code `4001`.

### Connection Acknowledgement

On successful connection:
```json
{
  "event": "connected",
  "data": { "clientId": "client_1", "timestamp": "2026-02-19T00:00:00.000Z" }
}
```

### Server-Pushed Events

All events follow this envelope format:
```json
{
  "event": "<event_name>",
  "data": { ... },
  "timestamp": "2026-02-19T00:00:00.000Z"
}
```

| Event | Data | Description |
|---|---|---|
| `wa_qr` | `{ qrDataUrl, qrGeneratedAt }` | New QR code generated for WhatsApp authentication |
| `wa_state` | `{ state, reason? }` | WhatsApp connection state changed |
| `message` | `{ chatId, message }` | New message sent or received |
| `message_edit` | `{ chatId, message }` | A message was edited |
| `message_delete` | `{ chatId, messageId }` | A message was deleted |
| `chat_update` | `{ action, chat? }` | Chat created (`action: "created"`) or sync started (`action: "sync_started"`) |
| `chats_synced` | `{ timestamp }` | Chat sync completed |
| `log_entry` | `{ level, type, message, createdAt }` | New server log entry |

---

## Error Response Format

All errors follow a consistent format:

```json
{
  "error": "ERROR_CODE",
  "message": "Human-readable description"
}
```

### Error Codes

| Code | HTTP Status | Description |
|---|---|---|
| `UNAUTHORIZED` | 401 | Missing or invalid API key |
| `FORBIDDEN` | 403 | Missing or invalid admin API key |
| `NOT_FOUND` | 404 | Resource not found |
| `NOT_A_GROUP` | 400 | Endpoint requires a group chat ID (`@g.us`) |
| `VALIDATION_ERROR` | 400 | Request body failed schema validation |
| `SERVICE_UNAVAILABLE` | 503 | WhatsApp is not connected |
| `EXPIRED` | 410 | Resource (e.g. join link) has expired |
| `SEND_FAILED` | 500 | Message send failed |
| `EDIT_FAILED` | 500 | Message edit failed |
| `DELETE_FAILED` | 500 | Message delete failed |
| `CREATE_FAILED` | 500 | Group creation failed |
| `SET_IMAGE_FAILED` | 500 | Setting group image failed |
| `ADD_FAILED` | 500 | Adding members failed |
| `JOIN_URL_FAILED` | 500 | Join URL generation failed |
| `SYNC_FAILED` | 500 | Chat sync failed |
| `RESTART_FAILED` | 500 | WhatsApp restart failed |
| `DISCONNECT_FAILED` | 500 | WhatsApp disconnect failed |
| `INTERNAL_ERROR` | 500 | General server error |

---

## Chat ID Formats

| Type | Format | Example |
|---|---|---|
| Individual | `<phone>@c.us` | `1234567890@c.us` |
| Group | `<group_id>@g.us` | `120363012345@g.us` |

Group-only endpoints (`/api/groups/add-members`, `/api/groups/join-url`, `/api/groups/:groupId/*`) will reject individual chat IDs with a `400 NOT_A_GROUP` error.
